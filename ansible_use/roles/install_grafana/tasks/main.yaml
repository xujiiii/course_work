---
- name: 导入 Grafana GPG 密钥
  rpm_key:
    state: present
    key: https://rpm.grafana.com/gpg.key
  become: yes
- name: 配置 Grafana Yum 仓库
  yum_repository:
    name: grafana
    description: Grafana Repository
    baseurl: https://rpm.grafana.com
    repo_gpgcheck: yes
    enabled: yes
    gpgcheck: yes
    gpgkey: https://rpm.grafana.com/gpg.key
    sslverify: yes
    sslcacert: /etc/pki/tls/certs/ca-bundle.crt
    state: present
  become: yes
- name: 安装 Grafana
  dnf:
    name: grafana
    state: present  # 确保安装，如果已安装则跳过
  become: yes
- name: 启动并启用 Grafana 服务
  systemd:
    name: grafana-server
    state: started
    enabled: yes
  become: yes
- name: 等待 Grafana 启动 API 响应
  wait_for:
    port: 3000
    delay: 2
  
- name: 自动连接本地 Prometheus 数据源 (幂等处理)
  uri:
    url: "http://localhost:3000/api/datasources"
    method: POST
    user: admin
    password: admin
    force_basic_auth: yes
    body_format: json
    body:
      name: "Prometheus"
      type: "prometheus"
      url: "http://localhost:9090"
      access: "proxy"
      isDefault: true
    # 200 表示创建成功，409 表示数据源已存在（即幂等性体现）
    status_code: [200, 409]
  become: yes